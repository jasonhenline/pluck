<script src="https://cdn.jsdelivr.net/npm/wavefile"></script>

<canvas id="pluck-shape"></canvas>
<canvas id="k-1"></canvas>
<canvas id="k-2"></canvas>
<canvas id="k-3"></canvas>
<canvas id="k-4"></canvas>
<canvas id="k-5"></canvas>
<canvas id="k-6"></canvas>

<script>
  // @ts-check

  integrate = (xi, k) => {
    let result = 0.0;
    let dx = 0.001;
    for (let x = 0; x < 1; x += dx) {
      let f;
      if (x < xi) {
        f = x / xi;
      } else {
        f = (x - 1) / (xi - 1);
      }
      result += f * Math.sin(k * Math.PI * x) * dx;
    }
    return result;
  };

  const hertz = 440;
  const samplesPerSecond = 44100;
  const amplitude = 32000;

  // The point at which you pluck.
  const xi = 0.6180339;

  const overtoneCount = 30;

  // Get the Fourier amplitudes for some k values.
  const componentAmplitudes = [0.0];
  const randomOffsets = [0.0];
  for (let k = 1; k < overtoneCount; k++) {
    componentAmplitudes.push(integrate(xi, k));
    randomOffsets.push(Math.random() * Math.PI);
  }

  console.log(componentAmplitudes);

  // Create some samples.
  const samples = [];

  const wavDurationInSeconds = 1.5;
  for (let i = 0; i < wavDurationInSeconds * samplesPerSecond; i++) {
    let value = 0.0;
    const envelope = 1.0;
    // Math.exp(
    //   (-0.1 * i) / (wavDurationInSeconds * samplesPerSecond)
    // );
    for (let k = 1; k < overtoneCount; k++) {
      const omega = k; //- 0.1 * k * k;
      value +=
        amplitude *
        componentAmplitudes[k] *
        Math.sin(
          (2.0 * Math.PI * omega * i * hertz) / samplesPerSecond +
            randomOffsets[k]
        );
    }
    samples.push(envelope * value);
  }

  const pureSamples = [];
  for (let i = 0; i < wavDurationInSeconds * samplesPerSecond; i++) {
    pureSamples.push(
      amplitude * Math.sin((2.0 * Math.PI * i * hertz) / samplesPerSecond)
    );
  }

  /**
   * Creates an audio element from an array of samples.
   *
   * @param {number[]} samples The array of samples.
   * @return {HTMLAudioElement}
   */
  function createAudioElement(samples) {
    const wav = new wavefile.WaveFile();
    wav.fromScratch(1, samplesPerSecond, "16", samples);
    const buffer = wav.toBuffer();
    const blob = new Blob([buffer], { type: "audio/wav" });
    const url = URL.createObjectURL(blob);
    return new Audio(url);
  }

  const audio = createAudioElement(samples);
  const pureAudio = createAudioElement(pureSamples);

  const pluckShapeCanvas = document.getElementById("pluck-shape");
  if (pluckShapeCanvas instanceof HTMLCanvasElement) {
    pluckShapeCanvas.height = 500;
    pluckShapeCanvas.width = 500;
    const context = pluckShapeCanvas.getContext("2d");
    if (context instanceof CanvasRenderingContext2D) {
      // axes
      context.lineWidth = 3;
      context.strokeStyle = "black";
      context.moveTo(10, 250);
      context.lineTo(490, 250);
      context.moveTo(10, 490);
      context.lineTo(10, 10);
      context.stroke();

      // string
      context.strokeStyle = "green";
      context.beginPath();
      context.moveTo(10, 250);
      context.lineTo(10 + xi * 490, 10);
      context.lineTo(480, 250);
      context.stroke();
    }
  }

  function drawComponent(name, amplitude, k) {
    const canvasElement = document.getElementById(name);
    if (canvasElement instanceof HTMLCanvasElement) {
      canvasElement.width = 500;
      canvasElement.height = 500;
      const context = canvasElement.getContext("2d");
      if (context instanceof CanvasRenderingContext2D) {
        // axes
        context.lineWidth = 3;
        context.strokeStyle = "black";
        context.moveTo(10, 250);
        context.lineTo(490, 250);
        context.moveTo(10, 490);
        context.lineTo(10, 10);
        context.stroke();

        // curve
        context.strokeStyle = "green";
        context.beginPath();
        context.moveTo(10, 250);
        for (i = 0; i < Math.PI; i += 0.1) {
          const value = -amplitude * Math.sin(k * i) + 250;
          context.lineTo(10 + 480 * (i / Math.PI), value);
        }
        context.lineTo(490, 250);
        context.stroke();
      }
    }
  }

  drawComponent("k-1", 230 * componentAmplitudes[1], 1);
  drawComponent("k-2", 230 * componentAmplitudes[2], 2);
  drawComponent("k-3", 230 * componentAmplitudes[3], 3);
  drawComponent("k-4", 230 * componentAmplitudes[4], 4);
  drawComponent("k-5", 230 * componentAmplitudes[5], 5);
  drawComponent("k-6", 230 * componentAmplitudes[6], 6);
</script>

<button onclick="pureAudio.play()">Click me to play pure</button>
<button onclick="audio.play()">Click me to play</button>
